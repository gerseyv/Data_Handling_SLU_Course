---
title: "Practice 2 with ggplot"
author: "Gersey Vargas"
date: "01/22/2026"
format: html 
fig-width: 8
fig-height: 4
code-fold: true
editor: visual
theme: "pulse"
---
# First exercise: Iris dataset

For this exercise we used the iris dataset to make a scatter plot showing the relationship between petal length and width of the three species: *Iris setosa*, *I. versicolor* and *I. virginica*.

```{r}
#| echo: true
#| message: false
#| warning: false
setwd("C:/GerseyNotSLU/Datahandlingcourse/")
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(ggrepel)
library(patchwork)
data("iris")

#We created a new theme changing the color of the text for the plot
newtheme <- theme(
    axis.title=element_text(color="Blue",face="bold"),
    plot.title=element_text(color="Blue",face="bold"),
    plot.subtitle=element_text(color="Pink"),
    panel.grid=element_blank())

#The ggplot
ggplot(data=iris,mapping=aes(x=Petal.Length,y=Petal.Width))+
  geom_point()+
  geom_smooth(method="lm")+
  #scale_color_continuous(name="New Legend Title")+ #gradient color
  scale_x_continuous(breaks=1:8)+ #breaks in x-axis
  labs(title="Petal length and width relationship",subtitle="Comparison of three Iris species",x=" Petal Length", 
       y="Petal Width", caption="This is where a little caption would go.")+
  facet_wrap(~Species)+
  theme_bw()+
  newtheme

```

## We also played with the legend in various ways:

Having two legends.

```{r}
ggplot(data=iris,mapping=aes(x=Petal.Length,y=Petal.Width))+
  geom_point(aes(color=Species,size=Sepal.Width)) #two legends

```

One legends.

```{r}
ggplot(data=iris,mapping=aes(x=Petal.Length,y=Petal.Width))+
  geom_point(aes(color=Species,size=Sepal.Width))+
  guides(size="none") #removes the last legend
```

No legends.

```{r}
ggplot(data=iris,mapping=aes(x=Petal.Length,y=Petal.Width))+
  geom_point(aes(color=Species,size=Sepal.Width),show.legend=FALSE) #removes all legends
```

Legend on the top.

```{r}
ggplot(data=iris,mapping=aes(x=Petal.Length,y=Petal.Width))+
  geom_point(aes(color=Species,size=Sepal.Width))+
  theme(legend.position="top",
        legend.justification="right") #legend on top
```

Legend on the top but organized into columns.

```{r}
ggplot(data=iris,mapping=aes(x=Petal.Length,y=Petal.Width))+
  geom_point(aes(color=Species,size=Sepal.Width))+
  guides(size=guide_legend(nrow=2,byrow=TRUE),
         color=guide_legend(nrow=3,byrow=T))+
  theme(legend.position="top",
        legend.justification="right") #legend on top but organized in columns
```

We can also add labels to the points.

```{r}
ggplot(data=iris,mapping=aes(x=Petal.Length,y=Petal.Width))+
  geom_point(aes(color=Species))+
  geom_text(aes(label=Species,hjust=0),nudge_x=0.5,size=3) #add labels to points
```

Add background to the point labels.

```{r}
ggplot(data=iris,mapping=aes(x=Petal.Length,y=Petal.Width))+
  geom_point(aes(color=Species))+
  geom_label(aes(label=Species,hjust=0),nudge_x=0.5,size=3) #add background to labels
```

Remove overlapping labels.

```{r}
#| message: false
#| warning: false
library(ggrepel)
ggplot(data=iris,mapping=aes(x=Petal.Length,y=Petal.Width))+
  geom_point(aes(color=Species))+
  geom_text_repel(aes(label=Species),size=3) #repel labels
```

Also add random text and shapes.

```{r}
ggplot(data=iris,mapping=aes(x=Petal.Length,y=Petal.Width))+
  geom_point(aes(color=Species))+
  annotate("text",x=2.5,y=2.1,label="There is a random line here")+
  annotate("segment",x=2,xend=4,y=1.5,yend=2) #add random text and shapes
```

And lastly we can add error bars to the means.

```{r}
dfr <- iris %>% group_by(Species) %>% 
  summarise(mean=mean(Sepal.Length),sd=sd(Sepal.Length)) %>%
  mutate(high=mean+sd,low=mean-sd)

ggplot(data=dfr,mapping=aes(x=Species,y=mean,color=Species))+
  geom_point(size=4)+
  geom_errorbar(aes(ymax=high,ymin=low),width=0.2)

```

# Exercise 2 Economist scatterplot

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false

ec <- read.csv("data_economist.csv",header=T)
head(ec)
str(ec)

#convert regions into different names(levels)
ec$Region <- factor(ec$Region,levels = c("EU W. Europe",
                                "Americas",
                                "Asia Pacific",
                                "East EU Cemt Asia",
                                "MENA",
                                "SSA"),
                     labels = c("OECD",
                                "Americas",
                                "Asia &\nOceania",
                                "Central &\nEastern Europe",
                                "Middle East &\nNorth Africa",
                                "Sub-Saharan\nAfrica"))

head(ec)

p <- ggplot(ec,aes(x=CPI,y=HDI,color=Region))+
  geom_smooth(aes(fill="red"),method="lm",formula=y~poly(x,2),se=F,color="red",size=0.6)+ #se controls the confidence interval
    geom_point(shape=21,size=3,stroke=1, fill = "white")+
  scale_color_brewer(palette = "Set2")

labels <- c("Congo","Afghanistan","Sudan","Myanmar","Iraq","Venezuela","Russia","Argentina","Brazil","Italy","South Africa","Cape Verde","Bhutan","Botswana","Britian","New Zealand","Greece","China","India","Rwanda","Spain","France","United States","Japan","Norway","Singapore","Barbados","Germany")

p+geom_text(data=subset(ec,Country %in% labels),aes(label=Country),color="black")
  
install.packages("extrafont")
library(extrafont)
font_import(pattern="Gidole",prompt=FALSE)
# load fonts for pdf
loadfonts()
# list available fonts in R
fonts()

p+geom_text(data=subset(ec,Country %in% labels),aes(label=Country), color="black",family="Gidole")

library(ggrepel)
p <- p+geom_text_repel(data=subset(ec,Country %in% labels),aes(label=Country),color="black",box.padding=unit(1,'lines'),segment.size=0.25, size=3,family="Gidole")

p <- p+scale_x_continuous(name="Corruption Perceptions Index, 2011 (10=least corrupt)", breaks=1:10,limits=c(1,10))+
      scale_y_continuous(name="Human Development Index, 2011 (1=best)",
                         breaks=seq(from=0,to=1,by=0.1),limits=c(0.2,1))

p <- p+scale_color_manual(values=c("#23576E","#099FDB","#29B00E", "#208F84","#F55840","#924F3E"))+
       scale_fill_manual(name="trend",values="red",labels=expression(paste(R^2,"=52%")))#change colors and add R2

p <- p+labs(title="Corruption and human development",
            caption="Sources: Transparency International; UN Human Development Report") #add title

p <- p+guides(color=guide_legend(nrow=1))+
       theme_bw(base_family="Gidole")+
       theme(legend.position="top")

p+theme(panel.grid.minor=element_blank(),
          panel.grid.major.x=element_blank(),
          panel.background=element_blank(),
          panel.border=element_blank(),
          legend.title=element_blank(),
          axis.title=element_text(face="italic"),
          axis.ticks.y=element_blank(),
          axis.ticks.x=element_line(color="grey60"),
          plot.title=element_text(face="bold"),
          plot.caption=element_text(hjust=0,size=8))

```

For this exercise we used data from different countries to look at the relationship between the Corruption Perceptions Index and Human Development Index in 2011.

```{r}
#| echo: true
#| message: false
#| warning: false
# read data
ec <- read.csv("C:/GerseyNotSLU/Datahandlingcourse/data_economist.csv",header=T)
# refactor
ec$Region <- factor(ec$Region,
                    levels = c("EU W. Europe","Americas","Asia Pacific",
                                "East EU Cemt Asia","MENA","SSA"),
                     labels = c("OECD","Americas","Asia &\nOceania",
                                "Central &\nEastern Europe",
                                "Middle East &\nNorth Africa",
                                "Sub-Saharan\nAfrica"))

# labels
labels <- c("Congo","Afghanistan","Sudan","Myanmar","Iraq","Venezuela","Russia","Argentina","Brazil","Italy","South Africa","Cape Verde","Bhutan","Botswana","Britian","New Zealand","Greece","China","India","Rwanda","Spain","France","United States","Japan","Norway","Singapore","Barbados","Germany")

# plotting
p1 <- ggplot(ec,aes(x=CPI,y=HDI,color=Region))+
      geom_smooth(aes(fill="red"),method="lm",formula=y~poly(x,2),se=F,color="red",size=0.6)+
      geom_point(shape=21,size=3,stroke=0.8,fill="white")+
      geom_text_repel(data=subset(ec,Country %in% labels),aes(label=Country),
                       color="black",box.padding=unit(1,'lines'),segment.size=0.25,
                       size=3,family="Gidole")+
      scale_x_continuous(name="Corruption Perceptions Index, 2011 (10=least corrupt)",
                          breaks=1:10,limits=c(1,10))+
      scale_y_continuous(name="Human Development Index, 2011 (1=best)",
                         breaks=seq(from=0,to=1,by=0.1),limits=c(0.2,1))+
      scale_color_manual(values=c("#23576E","#099FDB","#29B00E", "#208F84","#F55840","#924F3E"))+
           scale_fill_manual(name="trend",values="red",labels=expression(paste(R^2,"=52%")))+
      labs(title="Corruption and human development",
           caption="Sources: Transparency International; UN Human Development Report")+
      guides(color=guide_legend(nrow=1))+
      theme_bw(base_family="Gidole")+
      theme(legend.position="top",
            panel.grid.minor=element_blank(),
            panel.grid.major.x=element_blank(),
            panel.background=element_blank(),
            panel.border=element_blank(),
            legend.title=element_blank(),
            axis.title=element_text(face="italic"),
            axis.ticks.y=element_blank(),
            axis.ticks.x=element_line(color="grey60"),
            plot.title=element_text(face="bold"),
            plot.caption=element_text(hjust=0,size=8))
p1

```

# Last exercise: Measles heatmap in the US

Lastly, we made a heatmap to look at how the cases of measles changed over time in the 51 states of the US from 1930 to 2000. The lighter blue the squares the lower the case number. You can see how the cases dropped significantly after the vaccine was introduced.  

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false
me <- read.csv("C:/GerseyNotSLU/Datahandlingcourse/data_wsj.csv",header=T,stringsAsFactors=F,skip=2)
head(me)
str(me)
me1 <- me %>% gather(key=state,value=value,-YEAR,-WEEK) #gather() converts the wide format to long format in dplyr 
head(me1)
me2 <- me1 %>% mutate(value=str_replace(value,"^-$",NA_character_),
                      value=as.numeric(value)) #transform - to NAs and column from character to numeric
head(me2)

fun1 <- function(x) ifelse(all(is.na(x)),NA,sum(x,na.rm=TRUE)) #removes na from sum

me3 <- me2 %>% group_by(YEAR,state) %>% 
                summarise(total=fun1(value)) %>% 
                mutate(state=str_replace_all(state,"[.]"," "),
                       state=str_to_title(state)) #makes text like a title, first letter cap

colnames(me3) <- tolower(colnames(me3)) #change the casing of colname

ggplot(me3,aes(x=year,y=state,fill=total))+
       geom_tile()

p <- ggplot(me3,aes(x=year,y=reorder(state,desc(state)),fill=total))+
      geom_tile(color="white",size=0.25)

cols <- c("#e7f0fa","#c9e2f6","#95cbee","#0099dc","#4ab04a", "#ffd73e","#eec73a","#e29421","#f05336","#ce472e")

p + scale_y_discrete(expand=c(0,0))+ #expand crops scale so its more neat
    scale_x_continuous(expand=c(0,0),breaks=seq(1930,2010,by=10))+
    scale_fill_gradientn(colors=cols,na.value="grey95")


p <- p + scale_y_discrete(expand=c(0,0))+
        scale_x_continuous(expand=c(0,0),breaks=seq(1930,2010,by=10))+
        scale_fill_gradientn(colors=cols,na.value="grey95", limits=c(0,4000), values=c(0,0.01,0.02,0.05,0.1,0.2,0.3,0.4,0.6,0.8,1), labels=c("0k","1k","2k","3k","4k"), guide=guide_colourbar(ticks=T,nbin=50, barheight=.5,label=T, barwidth=10))

p <- p+labs(x="",y="",fill="",title="Measles")

p <- p+coord_fixed() #tiles seem a little enlongated, this makes them square

p <- p+geom_segment(x=1963,xend=1963,y=0,yend=51.5,size=.6,alpha=0.7) +
        annotate("text",label="Vaccine introduced",x=1963,y=53, 
                   vjust=1,hjust=0,size=I(3),family="Gidole")

p+theme_minimal(base_family="Gidole")+
  theme(legend.position="bottom",
        legend.justification="center",
        legend.direction="horizontal",
        legend.text=element_text(color="grey20"),
        axis.text.y=element_text(size=6,hjust=1,vjust=0.5),
        axis.text.x=element_text(size=8),
        axis.ticks.y=element_blank(),
        title=element_text(hjust=-.07,vjust=1),
        panel.grid=element_blank())


```

```{r}
#| echo: true
#| message: false
#| warning: false

# custom summing function
fun1 <- function(x) ifelse(all(is.na(x)),NA,sum(x,na.rm=TRUE))

# read data
me3 <- read.csv("C:/GerseyNotSLU/Datahandlingcourse/data_wsj.csv",header=T,
               stringsAsFactors=F,skip=2) %>%
        gather(key=state,value=value,-YEAR,-WEEK) %>%
        mutate(value=str_replace(value,"^-$",NA_character_),
                            value=as.numeric(value)) %>%
        group_by(YEAR,state) %>% 
                      summarise(total=fun1(value)) %>%
                      mutate(state=str_replace_all(state,"[.]"," "),
                             state=str_to_title(state))

colnames(me3) <- tolower(colnames(me3))

# custom colors
cols <- c("#e7f0fa","#c9e2f6","#95cbee","#0099dc","#4ab04a", "#ffd73e","#eec73a","#e29421","#f05336","#ce472e")

# plotting
p <- ggplot(me3,aes(x=year,y=reorder(state,desc(state)),fill=total))+
      geom_tile(color="white",size=0.25)+
      scale_y_discrete(expand=c(0,0))+
      scale_x_continuous(expand=c(0,0),breaks=seq(1930,2010,by=10))+
      scale_fill_gradientn(colors=cols,na.value="grey95",
                           limits=c(0,4000),
                           values=c(0,0.01,0.02,0.03,0.09,0.1,0.15,0.25,0.4,0.5,1),
                           labels=c("0k","1k","2k","3k","4k"),
                           guide=guide_colourbar(ticks=T,nbin=50,
                                               barheight=.5,label=T, 
                                               barwidth=10))+
      labs(x="",y="",fill="",title="Measles")+
      coord_fixed()+
      geom_segment(x=1963,xend=1963,y=0,yend=51.5,size=.9) +
      annotate("text",label="Vaccine introduced",x=1963,y=53, 
               vjust=1,hjust=0,size=I(3),family="Gidole")

p+theme_minimal(base_family="Gidole")+
  theme(legend.position="bottom",
        legend.justification="center",
        legend.direction="horizontal",
        legend.text=element_text(color="grey20"),
        axis.text.y=element_text(size=6,hjust=1,vjust=0.5),
        axis.text.x=element_text(size=8),
        axis.ticks.y=element_blank(),
        title=element_text(hjust=-.07,vjust=1),
        panel.grid=element_blank())

```
